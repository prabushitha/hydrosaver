package com.whileloop.hydrosaver;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.UUID;

import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.bluetooth.BluetoothSocket;
import android.content.Context;
import android.content.Intent;

public class ConnectDevice {
	
	
	
	
	Context context;
	
	private BluetoothAdapter btAdapter = null;
    private BluetoothSocket mmSocket;
    private BluetoothDevice mmDevice;
    private static String address = "20:15:12:04:25:83";
    private static final UUID MY_UUID = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");

    private OutputStream mmOutputStream;
    private InputStream mmInputStream;
    private Thread workerThread;

    //IBINDER
    boolean mBound = false;


    byte[] readBuffer;
    int readBufferPosition;
    volatile boolean stopWorker;
    
    //constructor
	public ConnectDevice(Context context){
		this.context = context;
	}
	
	//
	void init() {
        txtData = (TextView) findViewById(R.id.txtData);
        btAdapter = BluetoothAdapter.getDefaultAdapter();
        btnRefresh = (Button) findViewById(R.id.btnsync);

        if (btAdapter == null) {
            msgbox("You don't fucking have bluetooth broh!");
        } else {
            if (btAdapter.isEnabled()) {
                msgbox("Bluetooth  Activated!");

            } else {
                msgbox("Bluetooth  is deactivated!");
                Intent enableBtIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
                startActivityForResult(enableBtIntent, 1);
            }

        }
        btnRefresh.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                try {
                    findBT();
                    openBT();
                } catch (IOException ex) {
                    msgbox(ex.getMessage() + 3);
                }
                msgbox("Testing " + c);
                c++;
            }
        });
    }

    void findBT() {

        try {
            Set<BluetoothDevice> pairedDevices = btAdapter.getBondedDevices();

            if(pairedDevices.size() > 0) {
                for (BluetoothDevice device : pairedDevices) {

                    // RPP300 is the name of the bluetooth printer device
                    // we got this name from the list of paired devices
                    if (device.getAddress().equals(address)) {
                        mmDevice = device;
                        break;
                    }
                }
            }

            txtData.setText("Bluetooth device found." + mmDevice.getName());

        }catch(Exception e){
            msgbox(e.getMessage()+2);
        }
    }

    void openBT() throws IOException {
        try {

            // Standard SerialPortService ID
            //msgbox("PASS");
            mmSocket = mmDevice.createRfcommSocketToServiceRecord(MY_UUID);
            //msgbox("PASS");
            mmSocket.connect();
            mmOutputStream = mmSocket.getOutputStream();
            mmInputStream = mmSocket.getInputStream();

            beginListenForData();

            txtData.setText("Bluetooth Opened");

        } catch (Exception e) {
            msgbox(e.getMessage()+100000);
        }
    }
}
